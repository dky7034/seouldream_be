name: Backend CD (SSH & Safe Deploy)

on:
  push:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  # [JOB 1] 빌드 작업
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        # test 제외하고 빌드 (빠른 배포용)
        run: ./gradlew clean build --exclude-task test

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: spring-app
          # Gradle 빌드 결과물 경로 (프로젝트 설정에 따라 다를 수 있음)
          path: build/libs/app.jar

  # [JOB 2] 배포 작업
  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: spring-app
          path: build/libs

      # 1. 파일 전송 (SCP)
      - name: Transfer Jar to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_KEY }}
          source: "build/libs/app.jar"
          target: "/home/ubuntu/seouldream_be/temp"
          strip_components: 2

      # 2. 배포 스크립트 실행 (SSH)
      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            # 에러 발생 시 즉시 중단
            set -e

            # 프로젝트 폴더로 이동 (경로가 정확한지 확인 필수)
            cd /home/ubuntu/seouldream_be
            
            # [수정됨] 충돌 방지를 위해 강제 동기화 (git pull 대신 사용)
            # 서버의 로컬 변경사항을 무시하고 GitHub 최신 코드로 덮어씌움
            git fetch origin main
            git reset --hard origin/main

            # temp 폴더에서 전송된 jar 파일 꺼내오기
            mv temp/app.jar app.jar
            rm -rf temp

            # 기존 컨테이너 내리기
            sudo docker-compose down

            # (선택) 기존 이미지 삭제하여 공간 확보 (에러나도 무시하고 진행)
            sudo docker rmi seouldream_be_app || true

            # 다시 빌드 및 실행
            sudo docker-compose up -d --build

            # 불필요한 이미지 정리 (dangling images)
            sudo docker image prune -f

            echo "Backend deployed successfully!"