name: Backend CD (SSH & Safe Deploy)

on:
  push:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew clean build --exclude-task test

      # ë¹Œë“œëœ ê²°ê³¼ë¬¼(jar)ì„ ë‹¤ìŒ jobì¸ deployë¡œ ë„˜ê²¨ì£¼ê¸° ìœ„í•´ ì„ì‹œ ì €ì¥
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: spring-app
          path: build/libs/*.jar

    # deploy.yml ì˜ deploy job ë¶€ë¶„ ìˆ˜ì •

    deploy:
      needs: build
      runs-on: ubuntu-latest
      steps:
        - name: Download build artifact
          uses: actions/download-artifact@v4
          with:
            name: spring-app
            path: build/libs

        # 1. íŒŒì¼ ì „ì†¡ (ì´ì œ *.jar ëŒ€ì‹  app.jarë¥¼ ëª…ì‹œ)
        - name: Transfer Jar to Server
          uses: appleboy/scp-action@v0.1.7
          with:
            host: ${{ secrets.EC2_HOST }}
            username: ${{ secrets.EC2_USERNAME }}
            key: ${{ secrets.EC2_KEY }}
            source: "build/libs/app.jar"  # ğŸ‘ˆ ëª…í™•í•˜ê²Œ ì§€ì •!
            target: "/home/ubuntu/seouldream_be/temp"
            strip_components: 2

        # 2. ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        - name: Deploy to Server
          uses: appleboy/ssh-action@v1.0.3
          with:
            host: ${{ secrets.EC2_HOST }}
            username: ${{ secrets.EC2_USERNAME }}
            key: ${{ secrets.EC2_KEY }}
            script: |
              # ì—ëŸ¬ ë°œìƒ ì‹œ ì¦‰ì‹œ ì¤‘ë‹¨ (ë§¤ìš° ì¤‘ìš”!)
              set -e

              cd /home/ubuntu/seouldream_be

              # íŒŒì¼ êµì²´ (ì´ì œ íŒŒì¼ì´ 1ê°œë‹ˆ ì—ëŸ¬ ì•ˆ ë‚¨)
              mv temp/app.jar app.jar
              rm -rf temp

              # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ë‚´ë¦¬ê¸°
              sudo docker-compose down

              # (ì„ íƒ) ê¸°ì¡´ ì´ë¯¸ì§€ ì‚­ì œ (ìš©ëŸ‰ í™•ë³´)
              sudo docker rmi seouldream_be_app || true

              # ë‹¤ì‹œ ë¹Œë“œ ë° ì‹¤í–‰
              sudo docker-compose up -d --build

              # ë¶ˆí•„ìš”í•œ ì´ë¯¸ì§€ ì •ë¦¬
              sudo docker image prune -f

              echo "Backend deployed successfully!"