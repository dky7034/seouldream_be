name: Backend CD (SSH & Safe Deploy)

on:
  push:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  # [JOB 1] ë¹Œë“œ ì‘ì—…
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew clean build --exclude-task test

      # ğŸ’¡ ì¤‘ìš”: SCP ì „ì†¡ ì‹œ app.jarë€ ì´ë¦„ì„ ì“°ì‹œë ¤ë©´ íŒŒì¼ëª…ì„ ì—¬ê¸°ì„œ ë§ì¶°ì£¼ëŠ” ê²Œ ì•ˆì „í•©ë‹ˆë‹¤.
      # (Gradle ì„¤ì •ì—ì„œ íŒŒì¼ëª…ì„ ì§€ì •í•˜ì§€ ì•Šì•˜ë‹¤ë©´ ê¸°ë³¸ì ìœ¼ë¡œ ë²„ì „ëª…ì´ ë¶™ìŠµë‹ˆë‹¤)
      - name: Rename built jar to app.jar
        run: mv build/libs/*SNAPSHOT.jar build/libs/app.jar

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: spring-app
          path: build/libs/app.jar  # ë³€ê²½ëœ ì´ë¦„ìœ¼ë¡œ ì—…ë¡œë“œ

  # [JOB 2] ë°°í¬ ì‘ì—… (buildì™€ ê°™ì€ ë ˆë²¨ì´ì–´ì•¼ í•¨)
  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: spring-app
          path: build/libs

      # 1. íŒŒì¼ ì „ì†¡
      - name: Transfer Jar to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_KEY }}
          source: "build/libs/app.jar"
          target: "/home/ubuntu/seouldream_be/temp"
          strip_components: 2

      # 2. ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            set -e
            cd /home/ubuntu/seouldream_be
            
            # temp í´ë”ì—ì„œ êº¼ë‚´ì˜¤ê¸°
            mv temp/app.jar app.jar
            rm -rf temp

            sudo docker-compose down
            sudo docker rmi seouldream_be_app || true
            sudo docker-compose up -d --build
            sudo docker image prune -f

            echo "Backend deployed successfully!"