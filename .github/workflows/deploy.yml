name: Java CI with Gradle & Deploy to EC2

on:
  push:
    branches: [ "main" ] # main 브랜치에 푸시될 때 실행

permissions:
  contents: read

jobs:
  # 1. 테스트 및 빌드 검증 (CI)
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Build with Gradle
      run: ./gradlew clean build --exclude-task test 
      # 테스트를 포함하려면 --exclude-task test 제거. 
      # 현재 DB 연결 등이 없으면 테스트가 실패할 수 있어 일단 빌드만 체크함.

  # 2. EC2 배포 (CD)
  deploy:
    needs: build # build job이 성공해야 실행됨
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            # 프로젝트 경로로 이동 (폴더명은 실제 서버 상황에 맞게 수정 필요)
            cd /home/ubuntu/seouldream_be-develop 
            
            # 최신 코드 받기
            git pull origin main
            
            # 백엔드 컨테이너만 다시 빌드하고 재시작 (DB, Nginx는 건드리지 않음)
            # Dockerfile이 변경되었거나 소스가 변경되었으면 다시 빌드됨
            sudo docker-compose up -d --build app
            
            # 불필요한 이미지 정리 (용량 확보)
            sudo docker image prune -f
